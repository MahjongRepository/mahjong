# Mahjong ライブラリ解説

このドキュメントは、`MahjongRepository/mahjong` ライブラリの機能と内部構造について解説します。

## 1. ライブラリの概要

このライブラリは、日本の立直（リーチ）麻雀のルールに基づいた麻雀の手計算機能を提供することに特化した Python パッケージです。主な機能は以下の通りです。

- **手計算**: 和了（あがり）した手牌の点数（飜、符、役、最終スコア）を詳細に計算します。
- **向聴数（シャンテン）計算**: 手牌がテンパイまであと何枚の有効牌が必要か（向聴数）を計算します。

特筆すべき点として、このライブラリはオンライン麻雀サイト「天鳳」の膨大な対戦記録（1100万局以上）を用いて検証されており、非常に高い精度と信頼性を誇ります。

ライブラリは、麻雀の基本要素（牌、面子）から、複雑なロジック（和了判定、向聴数計算、役判定、符計算）まで、機能ごとにモジュール化されており、拡張性やメンテナンス性に優れた設計となっています。

## 2. 主要コンポーネント解説

ライブラリの中核をなす主要なモジュールについて解説します。これらのモジュールは `mahjong/` ディレクトリに配置されています。

### 2.1. `tile.py` - 牌の管理

麻雀の最も基本的な要素である「牌」を管理するモジュールです。

- **牌の表現**: ライブラリ内部では、136枚の物理的な牌を0から135までの整数で一意に識別します。これにより、赤ドラなどの同一牌も区別できます。また、計算時には34種類の牌種に集約した配列（`34 array`）も使用します。
- **形式変換**: `TilesConverter` クラスが、内部的な配列形式（136, 34）と、人間が読みやすい文字列形式（例: `123m456p789s11z`）との間の相互変換を担います。これにより、テストやデバッグが容易になっています。

### 2.2. `meld.py` - 面子の管理

ポン、チー、カンといった「面子（メンツ）」をオブジェクトとして管理します。

- **`Meld` クラス**: 1つの面子を表現するクラスです。面子の種類（`type`）、構成牌（`tiles`）、そして鳴きかどうか（`opened`）といった情報を保持します。これにより、手牌の構成を正確に表現できます。

### 2.3. `shanten.py` - 向聴数（シャンテン）計算

手牌が和了（あがり）まであと何手かを計算する、麻雀AIなどでも中核となるロジックです。

- **`Shanten` クラス**: 手牌（34種形式の配列）を受け取り、最小の向聴数を返します。
- **対応する手役**: 通常手（四面子一雀頭）だけでなく、特殊な役である**七対子（チートイツ）**や**国士無双（コクシムソウ）**の向聴数も個別に計算し、最も向聴数が少なくなるものを採用します。
- **計算アルゴリズム**: 通常手の計算では、手牌から面子や塔子（ターツ）、対子（トイツ）の候補を効率的に抜き出し、最も和了に近い組み合わせを見つけ出す再帰的な探索アルゴリズムが実装されています。

### 2.4. `agari.py` - 和了（あがり）判定

与えられた手牌が和了形を構成しているかどうかを判定するモジュールです。

- **`Agari` クラス**: `is_agari` メソッドが、手牌が物理的に和了しているかを判定します。
- **高速な判定**: このモジュールは、まず国士無双や七対子といった特殊な形をチェックします。通常形については、各スーツ（萬子・筒子・索子）の牌の数や組み合わせを数学的にチェックすることで、面子の組み合わせを全て試すことなく高速に判定する、洗練されたアルゴリズムを採用しています。

## 3. 手計算プロセス解説

このライブラリの最も重要な機能である点数計算は、`mahjong/hand_calculating/` ディレクトリ内のモジュール群によって実現されています。

### 3.1. `hand.py` - 手計算のオーケストレーター

`HandCalculator` クラスが、手計算プロセス全体を統括します。

1.  **入力**: 14枚の手牌、和了牌、鳴き面子、ドラ表示牌、その他ルール設定（立直、場風、自風など）を受け取ります。
2.  **検証**: まず、立直や天和などの役満に関する状況設定が、手牌の状態（鳴きなど）と矛盾しないかといった、広範なエラーチェックを行います。
3.  **分解**: `HandDivider` を呼び出し、手牌を全てのあり得る面子の組み合わせに分解させます。
4.  **評価**: 分解された各組み合わせに対して、役判定、符計算を行い、最も点数が高くなるものを最終結果として採用します。
5.  **出力**: `HandResponse` オブジェクトに、計算結果（飜、符、役リスト、点数）やエラー情報を格納して返します。

### 3.2. `divider.py` - 手牌の分解

和了形は、複数の解釈ができる場合があります（例: `222345`）。`HandDivider` は、与えられた手牌を、考えられる全ての有効な「四面子一雀頭」の組み合わせに分解する役割を担います。これにより、点数が最も高くなる最適な解釈を見つけることが可能になります。

### 3.3. `yaku.py` と `yaku_list/` - 役判定

麻雀の「役」を判定するロジックがここに集約されています。

- **`yaku.py`**: 全ての役の基底クラスと、役判定の全体設定を管理します。
- **`yaku_list/`**: `tanyao.py`, `pinfu.py` のように、各役の判定ロジックが個別のファイルとして実装されています。それぞれの役が成立する条件（牌の種類、面子の構成、鳴きの有無など）が記述されており、モジュール性が高く保たれています。

### 3.4. `fu.py` - 符計算

`FuCalculator` クラスが、和了手の符を計算します。符は、副底（フーテイ）、面子の種類（暗刻、明刻など）、雀頭の種類（役牌）、待ちの形（辺張、嵌張など）、ツモかロンか、といった細かい要素の積み重ねで決定され、その複雑な計算ロジックがここに実装されています。

### 3.5. `scores.py` - 点数計算

`ScoresCalculator` クラスが、最終的な飜（ハン）と符（フ）の合計から、実際の授受点数を計算します。「満貫」「跳満」といった切り上げ計算や、親と子の点数の違いなどもここで処理されます。

## 4. テストと検証

このライブラリは、その正確性を保証するために徹底的なテストが行われています。

- **単体テスト**: `tests/` ディレクトリには、各モジュール（和了判定、向聴数計算、牌の変換など）に対する詳細な単体テストが含まれています。これにより、個々の機能が期待通りに動作することが保証されます。
- **実戦データでの検証**: `README.md` に記載されている通り、このライブラリは **1100万局を超える「天鳳」のオンライン対戦記録** を用いてその計算結果が検証されています。これは、実際の複雑なゲーム状況においても、ライブラリがプロの対局サイトと同等の精度で点数計算を行えることを示しており、その信頼性を非常に高いものにしています。